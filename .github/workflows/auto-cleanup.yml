name: è‡ªåŠ¨æ¸…ç†è¡¨å•æäº¤

on:
  schedule:
    # æ¯6å°æ—¶è¿è¡Œä¸€æ¬¡
    - cron: '0 */6 * * *'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  cleanup:
    runs-on: ubuntu-latest
    permissions:
      issues: write
    
    steps:
      - name: æ¸…ç†24å°æ—¶å‰çš„Issues
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            
            // è·å–æ ‡è®°ä¸ºauto-deleteçš„å¼€æ”¾Issues
            const issues = await github.rest.issues.listForRepo({
              owner,
              repo,
              state: 'open',
              labels: 'auto-delete'
            });
            
            console.log(`æ‰¾åˆ° ${issues.data.length} ä¸ªå¾…æ¸…ç†çš„Issues`);
            
            const now = new Date();
            const cutoffTime = new Date(now.getTime() - 24 * 60 * 60 * 1000); // 24å°æ—¶å‰
            
            let cleanedCount = 0;
            
            for (const issue of issues.data) {
              const createdAt = new Date(issue.created_at);
              
              if (createdAt < cutoffTime) {
                try {
                  // å…³é—­Issue
                  await github.rest.issues.update({
                    owner,
                    repo,
                    issue_number: issue.number,
                    state: 'closed'
                  });
                  
                  // æ·»åŠ æ¸…ç†æ³¨é‡Š
                  await github.rest.issues.createComment({
                    owner,
                    repo,
                    issue_number: issue.number,
                    body: `
            ğŸ§¹ **è‡ªåŠ¨æ¸…ç†å®Œæˆ**
            
            æ­¤Issueå·²æ ¹æ®24å°æ—¶è‡ªåŠ¨æ¸…ç†è§„åˆ™è¢«å…³é—­ã€‚
            
            - **åˆ›å»ºæ—¶é—´ï¼š** ${issue.created_at}
            - **æ¸…ç†æ—¶é—´ï¼š** ${now.toISOString()}
            - **æ¸…ç†åŸå› ï¼š** è¶…è¿‡24å°æ—¶ä¿ç•™æœŸé™
            
            å¦‚éœ€é‡æ–°æäº¤ï¼Œè¯·ä½¿ç”¨è¡¨å•é¡µé¢é‡æ–°å¡«å†™ä¿¡æ¯ã€‚
                    `.trim()
                  });
                  
                  console.log(`å·²æ¸…ç†Issue #${issue.number}`);
                  cleanedCount++;
                  
                } catch (error) {
                  console.error(`æ¸…ç†Issue #${issue.number}å¤±è´¥:`, error.message);
                }
              }
            }
            
            console.log(`æœ¬æ¬¡å…±æ¸…ç† ${cleanedCount} ä¸ªIssues`);
            
            // è®¾ç½®è¾“å‡ºå˜é‡
            core.setOutput('cleaned-count', cleanedCount);
            core.setOutput('total-issues', issues.data.length);

      - name: è¾“å‡ºæ¸…ç†ç»Ÿè®¡
        run: |
          echo "âœ… è‡ªåŠ¨æ¸…ç†å®Œæˆ"
          echo "æ¸…ç†æ•°é‡: ${{ steps.cleanup.outputs.cleaned-count }}"
          echo "æ€»Issues: ${{ steps.cleanup.outputs.total-issues }}"